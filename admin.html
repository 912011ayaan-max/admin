<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>License Admin</title>
  <style>
    :root { --bg:#0b1020; --card:#121a2f; --muted:#93a4c4; --accent:#4f7cff; --text:#e8eefc; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; background:var(--bg); color:var(--text); }
    header { position:sticky; top:0; background:#0c1428cc; backdrop-filter:saturate(140%) blur(8px); border-bottom:1px solid #1f2a44; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
    .container { max-width:1100px; margin:20px auto; padding:0 16px; }
    .card { background:var(--card); border:1px solid #1f2a44; border-radius:12px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > * { flex:1 1 240px; }
    input, select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #243356; background:#0b1224; color:var(--text); }
    button { background:var(--accent); color:white; border:none; border-radius:8px; padding:10px 14px; cursor:pointer; }
    button.secondary { background:#223154; }
    table { width:100%; border-collapse:collapse; }
    th, td { border-bottom:1px solid #223154; padding:10px; text-align:left; }
    .status { display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:12px; }
    .status.active { background:#16321f; color:#9ae6b4; border:1px solid #1f5a33; }
    .status.banned { background:#381e1e; color:#feb2b2; border:1px solid #5a2a2a; }
    .status.expired { background:#3a2b14; color:#fbd38d; border:1px solid #5f451f; }
    .hidden { display:none; }
    code { color:#c7d5f2; }
  </style>
  <script>
    // Configure API base from ?api= param or saved setting
    (function(){
      const params = new URLSearchParams(window.location.search);
      const apiParam = params.get('api');
      if (apiParam) {
        try {
          const u = new URL(apiParam);
          localStorage.setItem('admin_api_base', `${u.origin}${u.pathname.replace(/\/$/, '')}`);
        } catch (e) { console.warn('Invalid api param:', apiParam); }
      }
    })();

    const savedApi = localStorage.getItem('admin_api_base');
    const isHttpsPage = window.location.protocol === 'https:';
    const defaultApi = isHttpsPage ? `${window.location.origin}/api` : 'http://localhost:3001/api';
    let API_BASE = (savedApi || defaultApi).replace(/\/$/, '');

    function setApiBase(v) {
      try {
        const u = new URL(v);
        API_BASE = `${u.origin}${u.pathname.replace(/\/$/, '')}`;
        localStorage.setItem('admin_api_base', API_BASE);
        alert('API base updated');
      } catch(e) { alert('Invalid API URL'); }
    }

    // Admin password is stored in localStorage
    function authHeader() {
      const pw = localStorage.getItem('ADMIN_PASSWORD') || '';
      return pw ? { 'X-Admin-Auth': pw } : {};
    }
    async function requirePassword() {
      const pw = localStorage.getItem('ADMIN_PASSWORD');
      if (!pw) { alert('Set admin password in the header and click Save PW.'); return false; }
      return true;
    }

    async function createCustomer(ev) {
      ev.preventDefault();
      if (!(await requirePassword())) return;
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const months = parseInt(document.getElementById('months').value || '6', 10);
      const maxDevices = parseInt(document.getElementById('maxDevices').value || '2', 10);
      if (!name || !email) return alert('Name and email required');
      const res = await fetch(`${API_BASE}/customers`, {
        method: 'POST', headers: { 'Content-Type': 'application/json', ...authHeader() },
        body: JSON.stringify({ name, email, months, maxDevices })
      });
      const data = await res.json().catch(()=>({}));
      if (!res.ok) return alert(data.error || 'Create failed');
      alert(`License created: ${data.licenseKey}`);
      listCustomers();
    }

    async function listCustomers() {
      if (!(await requirePassword())) return;
      const res = await fetch(`${API_BASE}/customers`, { headers: { ...authHeader() } });
      const data = await res.json().catch(()=>({ customers: [] }));
      if (!res.ok) return alert('Load customers failed');
      const tbody = document.getElementById('customersBody');
      tbody.innerHTML = '';
      for (const c of data.customers) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${c.name}</strong><div style="color:var(--muted); font-size:12px;">${c.email}</div></td>
          <td><code>${c.licenseKey}</code></td>
          <td><span class="status ${c.status}">${c.status}</span></td>
          <td>${new Date(c.expiresAt).toLocaleString()}</td>
          <td>${(c.activations?.length || 0)} / ${c.maxDevices}</td>
          <td>
            <div class="row" style="gap:8px;">
              <button onclick="copyText('${c.licenseKey}')">Copy</button>
              <button class="secondary" onclick="renew('${c.id}', 3)">+3m</button>
              <button class="secondary" onclick="renew('${c.id}', 6)">+6m</button>
              ${c.status === 'banned'
                ? `<button onclick=\"toggleBan('${c.id}', false)\">Unban</button>`
                : `<button onclick=\"toggleBan('${c.id}', true)\">Ban</button>`}
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function renew(id, months) {
      if (!(await requirePassword())) return;
      const res = await fetch(`${API_BASE}/customers/${id}/renew`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeader() },
        body: JSON.stringify({ months })
      });
      if (!res.ok) return alert('Renew failed');
      listCustomers();
    }

    async function toggleBan(id, banned) {
      if (!(await requirePassword())) return;
      const res = await fetch(`${API_BASE}/customers/${id}/ban`, {
        method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeader() },
        body: JSON.stringify({ banned })
      });
      if (!res.ok) return alert('Ban/unban failed');
      listCustomers();
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        const toast = document.getElementById('toast');
        toast.textContent = 'Copied license key';
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 1200);
      });
    }

    window.addEventListener('load', () => {
      // Wire header controls
      const apiInput = document.getElementById('apiBase');
      apiInput.value = API_BASE;
      document.getElementById('saveApi').addEventListener('click', () => setApiBase(apiInput.value.trim()));
      const pwInput = document.getElementById('adminPw');
      pwInput.value = localStorage.getItem('ADMIN_PASSWORD') || '';
      document.getElementById('savePw').addEventListener('click', () => {
        localStorage.setItem('ADMIN_PASSWORD', pwInput.value.trim());
        alert('Admin password saved');
      });

      listCustomers();
      document.getElementById('createForm').addEventListener('submit', createCustomer);
    });
  </script>
  <div id="toast" class="hidden" style="position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#1b2744; border:1px solid #2a3b66; color:#c7d5f2; padding:8px 12px; border-radius:8px;">Copied</div>
</head>
<body>
  <header>
    <div style="font-weight:700;">License Admin</div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="apiBase" placeholder="https://api.yourdomain.com/api" style="width:320px;" />
      <button class="secondary" id="saveApi">Save API</button>
      <input id="adminPw" placeholder="Admin password" type="password" style="width:200px;" />
      <button class="secondary" id="savePw">Save PW</button>
      <button class="secondary" onclick="localStorage.removeItem('ADMIN_PASSWORD'); alert('Password cleared. Reload to re-enter.');">Logout</button>
    </div>
  </header>
  <div class="container">
    <div class="card">
      <h2 style="margin:0 0 8px 0;">Create Customer</h2>
      <form id="createForm">
        <div class="row">
          <div><label>Name<br/><input id="name" placeholder="Customer name"/></label></div>
          <div><label>Email<br/><input id="email" placeholder="email@example.com"/></label></div>
        </div>
        <div class="row">
          <div><label>Months<br/><input id="months" type="number" min="1" value="6"/></label></div>
          <div><label>Max Devices<br/><input id="maxDevices" type="number" min="1" value="2"/></label></div>
        </div>
        <div style="margin-top:12px;">
          <button type="submit">Create & Generate Key</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px 0;">Customers</h2>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>License Key</th>
              <th>Status</th>
              <th>Expires</th>
              <th>Devices</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="customersBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>